version: '3.8'

services:
  dstack-vmm:
    image: dstack/vmm:latest
    container_name: dstack-vmm
    restart: unless-stopped
    ports:
      - "11530:11530"
    privileged: true
    volumes:
      - /var/run/dstack.sock:/var/run/dstack.sock
      - ./dstack-vmm-config:/config
    environment:
      - DSTACK_CONFIG_PATH=/config/vmm.toml
    networks:
      - platform-network

  validator:
    build:
      context: .
      dockerfile: Dockerfile
    image: platform-validator:latest
    container_name: platform-validator
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - VALIDATOR_HOTKEY=${VALIDATOR_HOTKEY}
      - PLATFORM_BASE_API=${PLATFORM_BASE_API:-http://platform-api:3000}
      - DSTACK_VMM_URL=${DSTACK_VMM_URL:-http://dstack-vmm:11530}
      - VALIDATOR_CPU_CORES=${VALIDATOR_CPU_CORES:-4}
      - VALIDATOR_MEMORY_MB=${VALIDATOR_MEMORY_MB:-2048}
      - VALIDATOR_DISK_MB=${VALIDATOR_DISK_MB:-10240}
      - VALIDATOR_GPU_COUNT=${VALIDATOR_GPU_COUNT:-0}
    volumes:
      - ./config.toml:/app/config.toml:ro
      - ./data:/data
    networks:
      - platform-network
    healthcheck:
      test: ["CMD", "./pv", "--help"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  platform-network:
    driver: bridge

